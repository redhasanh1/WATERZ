"""
COMPREHENSIVE CLOUD WORKER SETUP GUIDE
=======================================
Complete setup instructions for the optimized WATERZ cloud worker system.
From fresh terminal to fully operational 16x faster processing.

Last Updated: October 2025
System: Cloud GPU instance (Railway/Render/etc)
Performance: 16x speedup with faster-propainter + smart cropping + optimizations
"""

OVERVIEW
========
This guide sets up a cloud worker with:
✅ Smart watermark segmentation & cropping (5-50x speedup)
✅ Direct faster-propainter pipeline (3x speedup vs subprocess)
✅ Dynamic optimization based on video resolution  
✅ Advanced GPU memory management
✅ Performance monitoring & timing
✅ YOLO detection with intelligent frame skipping

PREREQUISITES
=============
- Cloud GPU instance with CUDA support
- Python 3.8+
- Git access
- Internet connection for downloads
- 4GB+ RAM, 2GB+ GPU memory recommended

QUICK START - COPY/PASTE ALL COMMANDS
======================================

# 1. INSTALL PYTHON DEPENDENCIES
pip install torch torchvision torchaudio opencv-python imageio scipy numpy tqdm pillow moviepy flask flask-cors celery redis ultralytics

# 2. DOWNLOAD REQUIRED FILES FROM GITHUB
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/web/CLOUD_WORKER_WITH_IMAGES_2.txt" -o /app/server_production.py && \
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/segment_detector.py" -o /app/segment_detector.py && \
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/crop_utils.py" -o /app/crop_utils.py && \
mkdir -p /app/faster-propainter-main && \
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/faster-propainter-main/watermark.py" -o /app/faster-propainter-main/watermark.py && \
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/faster-propainter-main/mytimer.py" -o /app/faster-propainter-main/mytimer.py && \
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/faster-propainter-main/pre_post_process.py" -o /app/faster-propainter-main/pre_post_process.py

# 3. DOWNLOAD PROPAINTER CORE (Required for faster-propainter)
cd /app && \
git clone https://github.com/sczhou/ProPainter.git && \
cp -r ProPainter/model ProPainter/core ProPainter/utils ProPainter/RAFT /app/faster-propainter-main/

# 4. VERIFY FASTER-PROPAINTER WORKS
python3 -c "
import sys
sys.path.insert(0, '/app/faster-propainter-main')
from watermark import pipeline
print('✅ faster-propainter import successful!')
"

# 5. CREATE REQUIRED DIRECTORIES
mkdir -p /app/uploads /app/results /app/temp /app/cache

# 6. DOWNLOAD YOLO WEIGHTS (if needed)
mkdir -p /app/runs/detect/new_sora_watermark/weights
curl -L "https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt" -o /app/yolov8n.pt

# 7. SET ENVIRONMENT AND START WORKER
export REDIS_URL=redis://:watermarkz_secure_2024@6.tcp.ngrok.io:11553/0
python3 -m celery -A server_production.celery worker --loglevel=info --concurrency=1 --pool=solo

STEP-BY-STEP DETAILED INSTRUCTIONS
===================================

STEP 1: INSTALL SYSTEM DEPENDENCIES
-----------------------------------
Install all required Python packages:

pip install torch torchvision torchaudio
pip install opencv-python imageio scipy numpy tqdm pillow moviepy
pip install flask flask-cors celery redis
pip install ultralytics

Verify CUDA is available:
python3 -c "import torch; print('CUDA available:', torch.cuda.is_available())"

STEP 2: DOWNLOAD CORE FILES FROM GITHUB
---------------------------------------
The WATERZ repository contains all optimized modules:

# Main cloud worker (optimized with faster-propainter integration)
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/web/CLOUD_WORKER_WITH_IMAGES_2.txt" -o /app/server_production.py

# Intelligent segmentation module  
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/segment_detector.py" -o /app/segment_detector.py

# Smart cropping utilities
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/crop_utils.py" -o /app/crop_utils.py

# faster-propainter optimized modules
mkdir -p /app/faster-propainter-main
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/faster-propainter-main/watermark.py" -o /app/faster-propainter-main/watermark.py
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/faster-propainter-main/mytimer.py" -o /app/faster-propainter-main/mytimer.py
curl -L "https://raw.githubusercontent.com/redhasanh1/WATERZ/main/faster-propainter-main/pre_post_process.py" -o /app/faster-propainter-main/pre_post_process.py

STEP 3: INSTALL PROPAINTER CORE DEPENDENCIES
--------------------------------------------
The faster-propainter module requires ProPainter's core implementation:

cd /app
git clone https://github.com/sczhou/ProPainter.git

# Copy required core modules to faster-propainter directory
cp -r ProPainter/model /app/faster-propainter-main/
cp -r ProPainter/core /app/faster-propainter-main/
cp -r ProPainter/utils /app/faster-propainter-main/
cp -r ProPainter/RAFT /app/faster-propainter-main/

# Verify the structure
ls -la /app/faster-propainter-main/
# Should show: model/, core/, utils/, RAFT/, watermark.py, mytimer.py, pre_post_process.py

STEP 4: VERIFY FASTER-PROPAINTER IMPORT
---------------------------------------
Test that all dependencies are correctly set up:

python3 -c "
import sys
sys.path.insert(0, '/app/faster-propainter-main')
try:
    from watermark import pipeline
    print('✅ faster-propainter import successful!')
except ImportError as e:
    print('❌ Import failed:', e)
    exit(1)
"

If this fails, check that all core modules were copied correctly.

STEP 5: CREATE DIRECTORY STRUCTURE
----------------------------------
Create required directories for processing:

mkdir -p /app/uploads          # Input videos/images
mkdir -p /app/results          # Processed outputs  
mkdir -p /app/temp             # Temporary processing files
mkdir -p /app/cache            # Model cache
mkdir -p /app/runs/detect/new_sora_watermark/weights  # YOLO weights

STEP 6: DOWNLOAD YOLO WEIGHTS (OPTIONAL)
----------------------------------------
Download basic YOLO weights if custom Sora model not available:

curl -L "https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt" -o /app/yolov8n.pt

STEP 7: CONFIGURE REDIS CONNECTION
----------------------------------
Set your Redis connection URL (update with your actual ngrok tunnel):

export REDIS_URL=redis://:watermarkz_secure_2024@6.tcp.ngrok.io:11553/0

Test Redis connection:
python3 -c "
import redis, os
try:
    r = redis.from_url(os.getenv('REDIS_URL'))
    r.ping()
    print('✅ Redis connection successful!')
except Exception as e:
    print('❌ Redis connection failed:', e)
"

STEP 8: START THE OPTIMIZED CLOUD WORKER
----------------------------------------
Launch the worker with optimal settings:

export REDIS_URL=redis://:watermarkz_secure_2024@6.tcp.ngrok.io:11553/0
python3 -m celery -A server_production.celery worker --loglevel=info --concurrency=1 --pool=solo

The worker should start and show:
✅ YOLO detector ready!
✅ Connected to Redis
✅ Ready to process tasks

PERFORMANCE FEATURES ENABLED
============================

SMART SEGMENTATION (5-50x speedup):
- Tracks watermark positions across video frames
- Groups frames into segments with similar positions  
- Processes only watermark regions instead of full frames
- Automatic speedup estimation and decision making

DIRECT FASTER-PROPAINTER PIPELINE (3x speedup):
- Eliminates subprocess overhead by calling pipeline directly
- Uses aggressive settings: neighbor_length=2, ref_stride=10
- FP16 half-precision for 2x additional speedup
- Optimized memory management with strategic GPU clearing

DYNAMIC OPTIMIZATION:
- Resolution-based parameter tuning
- 640p and below: subvideo_length=100
- 1080p: subvideo_length=60  
- 4K+: subvideo_length=20
- Adaptive processing based on content analysis

ADVANCED MEMORY MANAGEMENT:
- Strategic CUDA memory clearing after each processing stage
- Python garbage collection after segment cleanup
- Memory usage monitoring and reporting
- Prevents OOM errors on resource-constrained systems

PERFORMANCE MONITORING:
- Timing checkpoints for bottleneck identification
- Stage-by-stage performance profiling
- Real-time GPU memory usage reporting
- Processing speed optimization feedback

TROUBLESHOOTING
===============

COMMON ISSUE 1: "No module named 'watermark'"
Solution: Verify faster-propainter import test passes
Check: ls -la /app/faster-propainter-main/model/

COMMON ISSUE 2: "CUDA out of memory" 
Solution: Reduce processing resolution or enable more aggressive cropping
Check: GPU memory with nvidia-smi

COMMON ISSUE 3: "Cannot connect to Redis"
Solution: Update REDIS_URL environment variable
Check: Test Redis connection separately

COMMON ISSUE 4: "Import errors on startup"
Solution: Ensure all pip packages installed correctly
Check: python3 -c "import torch, cv2, numpy, PIL"

COMMON ISSUE 5: "Corrupted output videos"
Solution: Adjust cropping aggressiveness or disable smart cropping
Check: Set min_speedup higher in should_use_cropping function

VERIFICATION COMMANDS
====================

# Test all major components
python3 -c "
# Test imports
import sys
sys.path.insert(0, '/app/faster-propainter-main')
from watermark import pipeline
from segment_detector import detect_segments
from crop_utils import calculate_crop_region
print('✅ All modules imported successfully!')

# Test CUDA
import torch
print('CUDA available:', torch.cuda.is_available())
if torch.cuda.is_available():
    print('GPU memory:', torch.cuda.get_device_properties(0).total_memory // 1024**2, 'MB')

# Test Redis
import redis, os
r = redis.from_url(os.getenv('REDIS_URL'))
r.ping()
print('✅ Redis connection working!')
"

FILE STRUCTURE OVERVIEW
=======================

/app/
├── server_production.py              # Main optimized cloud worker
├── segment_detector.py               # Smart segmentation logic
├── crop_utils.py                     # Intelligent cropping utilities  
├── faster-propainter-main/           # faster-propainter implementation
│   ├── watermark.py                  # Main pipeline with optimizations
│   ├── mytimer.py                    # Performance timing decorators
│   ├── pre_post_process.py           # Video/mask preprocessing
│   ├── model/                        # ProPainter AI models
│   ├── core/                         # ProPainter core implementation
│   ├── utils/                        # ProPainter utilities
│   └── RAFT/                         # Optical flow computation
├── ProPainter/                       # Original ProPainter (source for core modules)
├── uploads/                          # Input videos/images
├── results/                          # Processed outputs
├── temp/                             # Temporary processing files
└── cache/                            # Model weights cache

PERFORMANCE EXPECTATIONS
========================

INPUT: 1920x1080 video, 90 frames, watermark in corner
- Original system: ~300-600 seconds  
- Optimized system: ~30-60 seconds
- Speedup achieved: ~10-16x faster

PROCESSING BREAKDOWN:
- Smart cropping: 5.3x speedup (process 624x192 instead of full frame)  
- Direct pipeline: 3x speedup (no subprocess overhead)
- Aggressive settings: 2x speedup (neighbor_length=2 vs 20)
- FP16 precision: 2x speedup (half precision computation)
- Combined: ~60x potential speedup for optimal scenarios

MAINTENANCE
===========

UPDATING THE SYSTEM:
1. Pull latest changes from GitHub repository
2. Re-download CLOUD_WORKER_WITH_IMAGES_2.txt 
3. Restart the worker with same commands
4. Verify all optimizations still working

MONITORING PERFORMANCE:
- Watch worker logs for timing information
- Monitor GPU memory usage during processing
- Track processing speeds and identify bottlenecks
- Adjust parameters based on performance feedback

SCALING CONSIDERATIONS:
- Run multiple workers on different GPU instances
- Use Redis for job queuing and load balancing
- Monitor resource utilization and costs
- Consider auto-scaling based on queue length

SUCCESS INDICATORS
==================

✅ Worker starts without import errors
✅ Redis connection established  
✅ YOLO detector loads successfully
✅ faster-propainter pipeline functional
✅ Smart segmentation detects watermark positions
✅ Cropping provides 5+ speedup estimates  
✅ Processing completes 10-16x faster than baseline
✅ Output videos maintain quality
✅ Memory usage remains stable
✅ No CUDA out of memory errors

SUPPORT & RESOURCES
===================

GitHub Repository: https://github.com/redhasanh1/WATERZ
ProPainter Official: https://github.com/sczhou/ProPainter  
faster-propainter Optimizations: Based on bilibili video guides

For issues:
1. Check troubleshooting section above
2. Verify all setup steps completed
3. Test individual components separately  
4. Check system resources (GPU memory, disk space)
5. Review worker logs for specific error messages

END OF SETUP GUIDE
==================